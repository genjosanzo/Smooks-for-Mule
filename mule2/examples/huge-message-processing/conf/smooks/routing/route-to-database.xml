<?xml version="1.0"?>
<smooks-resource-list xmlns="http://www.milyn.org/xsd/smooks-1.0.xsd">

	<!--
		This SQLExecutor resource configuration executes a query that counts the number
		of products in the external database. It is only here for the example.
		Conditions later on  restrict writing to the database when 99 products are written.
		We use it to prevent flooding of the database with thousands of product and part records.
	-->
	<resource-config selector="product">
		<resource>org.milyn.routing.db.SQLExecutor</resource>
		<param name="executeBefore">true</param>
		<param name="datasource">ExternalDatabase</param>
		<param name="statement">select count(*) as "numberProducts" from EXT_PRODUCT</param>
		<param name="resultSetName">productCount</param>
	</resource-config>

	<resource-config selector="product guarantee">
		<resource>org.milyn.routing.db.SQLExecutor</resource>
		<condition evaluator="org.milyn.javabean.expression.BeanMapExpressionEvaluator">
			<!-- productStock > 20 && productCount[0].numberProducts < 100  -->
		</condition>
		<param name="executeBefore">false</param>
		<param name="datasource">ExternalDatabase</param>
		<param name="statement">insert into EXT_PRODUCT values(${product.id}, ${product.name}, ${product.brand}, ${product.category}, ${product.price}, ${product.tax}, now())</param>
	</resource-config>

	<resource-config selector="product part">
		<resource>org.milyn.routing.db.SQLExecutor</resource>
		<condition evaluator="org.milyn.javabean.expression.BeanMapExpressionEvaluator"><!--
			productStock > 20 && productCount[0].numberProducts < 100
		--></condition>
		<param name="executeBefore">false</param>
		<param name="datasource">ExternalDatabase</param>
		<param name="statement">insert into EXT_PART values(${part.id}, ${product.id}, ${partDetails[0].NAME}, ${partDetails[0].BRAND})</param>
	</resource-config>

</smooks-resource-list>
