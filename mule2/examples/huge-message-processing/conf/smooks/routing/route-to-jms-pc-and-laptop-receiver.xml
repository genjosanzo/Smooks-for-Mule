<?xml version="1.0"?>
<smooks-resource-list xmlns="http://www.milyn.org/xsd/smooks-1.0.xsd">

	<!--
   		This MuleDispatcher resource configuration executes at the end of every product.
   		It dispatches the product JSON to the 'JSON_ReceivePCsAndLaptops' endpoint. Because
   		of the condition it only dispatches if the product category is
   		"Complete Systems" or "Laptops".
   		The JSON is retrieved from the 'JSON_ReceivePCsAndLaptops' String from the bean Map.
   		This JSON is generated by the next resource configuration.

   		For the same reasons as explained in the top of the config.xml file the dispatch
   		configurion must come for the JSON generating configuration. Both execute in the
   		visit after action.
	-->
	<resource-config selector="product">
		<resource>org.milyn.smooks.mule.MuleDispatcher</resource>
		<condition evaluator="org.milyn.javabean.expression.BeanMapExpressionEvaluator">
			 <!--  product.category == "Complete Systems" || product.category == "Laptops" -->
		</condition>
		<param name="endpointName">ReceivePCsAndLaptopsEndpoint</param>
		<param name="beanId">JSON_ReceivePCsAndLaptops</param>
	</resource-config>

	<!--
   		This FreeMarker template resource configuration generates the JSON
   		at the end of every product. It binds the JSON String in the bean map under
   		bean ID 'JSON_ReceivePCsAndLaptops'.
	-->
	<resource-config selector="product">
		<resource type="ftl"><!--
			{
				"id" : ${product.id?c},
				"name" : "${product.name}",
				"brand" : "${product.brand}",
				"category" : <#if product.category == "Complete Systems">1<#else>2</#if>,
				"price" : ${product.price?c},
				"tax" : ${product.tax?c},
				"parts" : [
				<#list product.parts as part>
		        	${part.id?c}<#if part_has_next>,</#if>
		        </#list>
				]
			}
   		--></resource>
   		<condition evaluator="org.milyn.javabean.expression.BeanMapExpressionEvaluator">
			<!-- (product.category == "Complete Systems" || product.category == "Laptops")  -->
		</condition>
		<param name="action">bindto</param>
		<param name="bindId">JSON_ReceivePCsAndLaptops</param>
	</resource-config>

</smooks-resource-list>
