<?xml version="1.0"?>
<smooks-resource-list xmlns="http://www.milyn.org/xsd/smooks-1.1.xsd"
	xmlns:mule="http://dist.muleforge.org/smooks/schema/smooks-mule-1.2.xsd"
	xmlns:ftl="http://www.milyn.org/xsd/smooks/freemarker-1.1.xsd">


	<conditions>
		<!--
			This condition checks that a product is defined and that it is in the correct category.
		 -->
		<condition id="productInCertainCategories">
			<!-- VARS.isdef("product") && product != null && (product.category == "Complete Systems" || product.category == "Laptops") -->
		</condition>
	</conditions>

	<!--
   		This FreeMarker template resource configuration generates the JSON
   		at the end of every product. It binds the JSON String in the bean map under
   		bean ID 'JSON_ReceivePCsAndLaptops'.
	-->
	<ftl:freemarker applyOnElement="product">
		<condition idRef="productInCertainCategories" />
		<ftl:template><!--
			{
				"id" : ${product.id?c},
				"name" : "${product.name}",
				"brand" : "${product.brand}",
				"category" : <#if product.category == "Complete Systems">1<#else>2</#if>,
				"price" : ${product.price?c},
				"tax" : ${product.tax?c},
				"parts" : [
				<#list product.parts as part>
		        	${part.id?c}<#if part_has_next>,</#if>
		        </#list>
				]
			}
   		-->
   		</ftl:template>
    	<ftl:use><ftl:bindTo id="JSON_ReceivePCsAndLaptops"/></ftl:use>
    </ftl:freemarker>

	<!--
   		This MuleDispatcher resource configuration executes at the end of every product.
   		It dispatches the product JSON to the 'JSON_ReceivePCsAndLaptops' endpoint. Because
   		of the condition it only dispatches if the product category is
   		"Complete Systems" or "Laptops".
   		The JSON is retrieved from the 'JSON_ReceivePCsAndLaptops' String from the bean Map.
   		This JSON is generated by the next resource configuration.
	-->
	<mule:dispatcher endpointName="ReceivePCsAndLaptopsEndpoint" dispatchOnElement="product">
		<condition idRef="productInCertainCategories" />
		<mule:messagePayload beanId="JSON_ReceivePCsAndLaptops" />
	</mule:dispatcher>

</smooks-resource-list>
